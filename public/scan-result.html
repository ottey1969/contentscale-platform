<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ContentScale - Client Scan Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
    .modal.active { display: flex; }
    .modal-content { background: #1f2937; border-radius: 16px; padding: 32px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; }
    .modal-close { position: absolute; top: 16px; right: 16px; background: #374151; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; color: white; font-size: 20px; }
    .modal-close:hover { background: #4b5563; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold text-blue-400">üìä ContentScale Client Portal</h1>
      <p class="text-gray-400 text-sm">Analyze your content with AI-powered insights</p>
    </div>
  </div>

  <div class="container mx-auto px-6 py-8 max-w-4xl">
    
    <div id="loading" class="text-center py-12">
      <div class="text-6xl mb-4 animate-pulse">‚è≥</div>
      <p class="text-xl text-gray-400">Validating access...</p>
    </div>

    <div id="error-state" class="hidden bg-red-900 border border-red-700 rounded-lg p-6 text-center">
      <h3 class="text-2xl font-bold mb-2" id="error-title">‚ùå Access Error</h3>
      <p class="text-gray-400 mb-4" id="error-message">There was a problem with your scan link.</p>
      <div id="error-contact" class="mt-6 p-4 bg-gray-800 rounded-lg">
        <p class="text-sm text-gray-400 mb-3">Need help? Contact us:</p>
        <div class="flex justify-center gap-3">
          <a href="https://wa.me/31628073996" target="_blank" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-bold text-sm transition">
            üí¨ WhatsApp
          </a>
          <a href="mailto:info@contentscale.site" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-bold text-sm transition">
            üìß Email
          </a>
        </div>
      </div>
    </div>

    <div id="scan-interface" class="hidden">
      <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Welcome, <span id="client-name" class="text-blue-400">Client</span>!</h2>
        <div class="grid md:grid-cols-3 gap-4 mb-4">
          <div class="bg-gray-700 rounded-lg p-4">
            <div class="text-sm text-gray-400 mb-1">Scans Available</div>
            <div class="text-2xl font-bold text-green-400" id="scans-remaining">0</div>
          </div>
          <div class="bg-gray-700 rounded-lg p-4">
            <div class="text-sm text-gray-400 mb-1">Scans Used</div>
            <div class="text-2xl font-bold text-blue-400" id="scans-used">0</div>
          </div>
          <div class="bg-gray-700 rounded-lg p-4">
            <div class="text-sm text-gray-400 mb-1">Expires</div>
            <div class="text-sm font-bold" id="expires-at">-</div>
          </div>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">üîç Analyze Your Content</h3>
        <div class="flex gap-3 mb-4">
          <input type="text" id="scan-url" placeholder="https://yourwebsite.com/page" class="flex-1 bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <button onclick="performScan()" id="scan-btn" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold transition">
            Scan Now
          </button>
        </div>
        <p class="text-xs text-gray-400">Enter the full URL of the page you want to analyze</p>
      </div>
    </div>

  </div>

  <!-- RESULTS MODAL -->
  <div id="resultsModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeResultsModal()">√ó</button>
      
      <div class="text-center mb-6">
        <div class="text-6xl mb-3" id="modal-emoji">üéØ</div>
        <div class="text-5xl font-bold mb-2" id="modal-score">--/100</div>
        <div class="text-lg text-gray-400" id="modal-quality">Analyzing...</div>
        <div class="text-sm text-gray-500 mt-2" id="modal-url"></div>
      </div>
      
      <div class="mb-6">
        <h3 class="font-bold text-lg mb-3">Score Breakdown:</h3>
        <div class="grid grid-cols-3 gap-4">
          <div class="bg-blue-900/30 rounded-lg p-4 text-center">
            <div class="text-sm text-gray-400 mb-1">üéØ GRAAF</div>
            <div class="text-2xl font-bold text-blue-400" id="modal-graaf">-/50</div>
          </div>
          <div class="bg-purple-900/30 rounded-lg p-4 text-center">
            <div class="text-sm text-gray-400 mb-1">‚ö° CRAFT</div>
            <div class="text-2xl font-bold text-purple-400" id="modal-craft">-/30</div>
          </div>
          <div class="bg-green-900/30 rounded-lg p-4 text-center">
            <div class="text-sm text-gray-400 mb-1">üîß Technical</div>
            <div class="text-2xl font-bold text-green-400" id="modal-technical">-/20</div>
          </div>
        </div>
      </div>

      <!-- RECOMMENDATIONS -->
      <div id="recommendations-section" class="mb-6 hidden">
        <h3 class="font-bold text-xl mb-4">üí° Recommendations to Reach 100/100</h3>
        
        <div class="bg-gray-800 rounded-lg p-4 mb-4">
          <div class="grid grid-cols-3 gap-4 text-center text-sm">
            <div>
              <div class="text-2xl font-bold text-blue-400" id="rec-total-issues">0</div>
              <div class="text-gray-400">Issues Found</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-purple-400" id="rec-time">0h</div>
              <div class="text-gray-400">Est. Fix Time</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-400" id="rec-gain">+0</div>
              <div class="text-gray-400">Score Gain</div>
            </div>
          </div>
        </div>

        <div id="quick-wins-section" class="hidden mb-4">
          <div class="bg-green-900/20 border border-green-700 rounded-lg p-4">
            <h4 class="font-bold text-green-400 mb-3">‚ö° Quick Wins (High Impact, Low Time)</h4>
            <div id="quick-wins-list" class="space-y-2"></div>
          </div>
        </div>

        <div id="major-impact-section" class="hidden mb-4">
          <div class="bg-orange-900/20 border border-orange-700 rounded-lg p-4">
            <h4 class="font-bold text-orange-400 mb-3">üéØ Major Impact (Critical for 90+)</h4>
            <div id="major-impact-list" class="space-y-2"></div>
          </div>
        </div>

        <div id="advanced-section" class="hidden">
          <div class="bg-purple-900/20 border border-purple-700 rounded-lg p-4">
            <h4 class="font-bold text-purple-400 mb-3">üöÄ Advanced (For 95+)</h4>
            <div id="advanced-list" class="space-y-2"></div>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <button onclick="downloadPDFReport()" class="w-full bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 px-6 py-4 rounded-lg font-bold text-lg transition flex items-center justify-center gap-2">
          <span class="text-2xl">üìÑ</span>
          <span>Download PDF Report</span>
        </button>
        
        <button onclick="scanAnother()" class="w-full bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold transition">
          üîç Scan Another Page (<span id="remaining-scans">0</span> left)
        </button>
        
        <button onclick="closeResultsModal()" class="w-full bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-bold transition">Close</button>
      </div>
    </div>
  </div>

  <script>
    console.log('üöÄ Share Link Scanner v2.0 LOADED');
    
    let shareCode = '';
    let linkData = null;
    let currentScanResult = null;

    async function validateLink() {
      shareCode = window.location.pathname.split('/').pop();
      console.log('üîç Validating share code:', shareCode);
      
      try {
        const response = await fetch(`/api/share-link/validate/${shareCode}`);
        const data = await response.json();
        
        console.log('‚úÖ Link validation response:', data);
        
        if (!data.success) {
          showError(data.status, data.error, data);
          return;
        }
        
        linkData = data;
        showScanInterface(data);
        
      } catch (error) {
        console.error('‚ùå Validation error:', error);
        showError('error', 'Failed to validate link');
      }
    }

    function showError(status, message, data = {}) {
      document.getElementById('loading').classList.add('hidden');
      const errorState = document.getElementById('error-state');
      
      let title = '‚ùå Access Error';
      let msg = message;
      
      if (status === 'expired') {
        title = '‚è∞ Link Expired';
        msg = `This scan link expired on ${new Date(data.expires_at).toLocaleDateString()}`;
      } else if (status === 'limit_reached') {
        title = 'üö´ Scan Limit Reached';
        msg = `All ${data.scans_limit} scans have been used`;
      } else if (status === 'inactive') {
        title = 'üîí Link Deactivated';
        msg = 'This scan link has been deactivated';
      }
      
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-message').textContent = msg;
      errorState.classList.remove('hidden');
    }

    function showScanInterface(data) {
      console.log('‚úÖ Showing scan interface');
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('scan-interface').classList.remove('hidden');
      
      document.getElementById('client-name').textContent = data.client_name || data.company || 'Valued Client';
      document.getElementById('scans-remaining').textContent = data.scans_remaining;
      document.getElementById('scans-used').textContent = data.scans_used;
      document.getElementById('expires-at').textContent = new Date(data.expires_at).toLocaleDateString();
    }

    async function performScan() {
      const url = document.getElementById('scan-url').value.trim();
      
      if (!url) {
        alert('Please enter a URL');
        return;
      }
      
      if (!url.startsWith('http')) {
        document.getElementById('scan-url').value = 'https://' + url;
        return performScan();
      }
      
      const btn = document.getElementById('scan-btn');
      btn.disabled = true;
      btn.textContent = 'Scanning...';
      
      console.log('üîç Scanning URL:', url);
      console.log('üîç Share code:', shareCode);
      
      try {
        const response = await fetch('/api/share-link/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ share_code: shareCode, url })
        });
        
        const data = await response.json();
        
        console.log('üìä RAW SCAN RESPONSE:', data);
        console.log('üìä Has recommendations?', !!data.recommendations);
        console.log('üìä Recommendations object:', data.recommendations);
        
        if (data.recommendations) {
          console.log('‚úÖ Quick Wins:', data.recommendations.quickWins?.length || 0);
          console.log('‚úÖ Major Impact:', data.recommendations.majorImpact?.length || 0);
          console.log('‚úÖ Advanced:', data.recommendations.advanced?.length || 0);
          console.log('‚úÖ Summary:', data.recommendations.summary);
        } else {
          console.log('‚ùå NO RECOMMENDATIONS IN RESPONSE!');
        }
        
        if (!data.success) {
          if (data.status === 'limit_reached') {
            alert('‚ö†Ô∏è All scans have been used! Contact us for more scans.');
          } else {
            alert('Scan failed: ' + (data.error || 'Unknown error'));
          }
          return;
        }
        
        currentScanResult = data;
        showResults(data);
        
        if (data.scans_remaining !== undefined) {
          document.getElementById('scans-remaining').textContent = data.scans_remaining;
          document.getElementById('scans-used').textContent = (linkData.scans_limit - data.scans_remaining);
          document.getElementById('remaining-scans').textContent = data.scans_remaining;
        }
        
      } catch (error) {
        console.error('‚ùå Scan error:', error);
        alert('Scan failed: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Scan Now';
      }
    }

    function showResults(data) {
      console.log('üéØ SHOWING RESULTS - START');
      console.log('Data:', data);
      
      document.getElementById('modal-score').textContent = data.score + '/100';
      document.getElementById('modal-quality').textContent = getQualityText(data.score);
      document.getElementById('modal-emoji').textContent = getQualityEmoji(data.score);
      document.getElementById('modal-url').textContent = data.url;
      
      document.getElementById('modal-graaf').textContent = `${data.breakdown.graaf.total}/50`;
      document.getElementById('modal-craft').textContent = `${data.breakdown.craft.total}/30`;
      document.getElementById('modal-technical').textContent = `${data.breakdown.technical.total}/20`;
      
      console.log('‚úÖ Basic info displayed');
      
      // RECOMMENDATIONS
      const recSection = document.getElementById('recommendations-section');
      
      if (!recSection) {
        console.error('‚ùå recommendations-section element NOT FOUND!');
        return;
      }
      
      console.log('‚úÖ Found recommendations section element');
      
      if (data.recommendations) {
        console.log('‚úÖ Data has recommendations, displaying...');
        
        recSection.classList.remove('hidden');
        console.log('‚úÖ Removed hidden class from section');
        
        // Summary
        const totalIssues = data.recommendations.summary.totalIssues;
        const timeToFix = data.recommendations.summary.estimatedTimeToFix;
        const scoreGain = data.recommendations.summary.potentialScoreGain;
        
        console.log('Summary:', { totalIssues, timeToFix, scoreGain });
        
        document.getElementById('rec-total-issues').textContent = totalIssues;
        document.getElementById('rec-time').textContent = Math.round(timeToFix / 60) + 'h';
        document.getElementById('rec-gain').textContent = '+' + scoreGain;
        
        console.log('‚úÖ Summary displayed');
        
        // Quick Wins
        if (data.recommendations.quickWins && data.recommendations.quickWins.length > 0) {
          console.log('‚úÖ Displaying Quick Wins:', data.recommendations.quickWins.length);
          
          const quickWinsSection = document.getElementById('quick-wins-section');
          const quickWinsList = document.getElementById('quick-wins-list');
          
          if (!quickWinsSection || !quickWinsList) {
            console.error('‚ùå Quick wins elements not found!');
          } else {
            quickWinsSection.classList.remove('hidden');
            
            quickWinsList.innerHTML = data.recommendations.quickWins.map((rec, i) => `
              <div class="bg-gray-800 rounded p-3 text-sm">
                <div class="flex justify-between items-start mb-1">
                  <div class="font-bold text-green-400">${i + 1}. ${rec.action}</div>
                  <div class="text-xs text-gray-400">${rec.timeEstimate}min | +${rec.impact}pts</div>
                </div>
                <div class="text-xs text-gray-400">${rec.issue}</div>
              </div>
            `).join('');
            
            console.log('‚úÖ Quick Wins HTML injected');
          }
        } else {
          console.log('‚ö†Ô∏è No Quick Wins to display');
        }
        
        // Major Impact
        if (data.recommendations.majorImpact && data.recommendations.majorImpact.length > 0) {
          console.log('‚úÖ Displaying Major Impact:', data.recommendations.majorImpact.length);
          
          const majorSection = document.getElementById('major-impact-section');
          const majorList = document.getElementById('major-impact-list');
          
          if (!majorSection || !majorList) {
            console.error('‚ùå Major impact elements not found!');
          } else {
            majorSection.classList.remove('hidden');
            
            majorList.innerHTML = data.recommendations.majorImpact.map((rec, i) => `
              <div class="bg-gray-800 rounded p-3 text-sm">
                <div class="flex justify-between items-start mb-1">
                  <div class="font-bold text-orange-400">${i + 1}. ${rec.action}</div>
                  <div class="text-xs text-gray-400">${rec.timeEstimate}min | +${rec.impact}pts</div>
                </div>
                <div class="text-xs text-gray-400">${rec.issue}</div>
              </div>
            `).join('');
            
            console.log('‚úÖ Major Impact HTML injected');
          }
        } else {
          console.log('‚ö†Ô∏è No Major Impact to display');
        }
        
        // Advanced
        if (data.recommendations.advanced && data.recommendations.advanced.length > 0) {
          console.log('‚úÖ Displaying Advanced:', data.recommendations.advanced.length);
          
          const advSection = document.getElementById('advanced-section');
          const advList = document.getElementById('advanced-list');
          
          if (!advSection || !advList) {
            console.error('‚ùå Advanced elements not found!');
          } else {
            advSection.classList.remove('hidden');
            
            advList.innerHTML = data.recommendations.advanced.map((rec, i) => `
              <div class="bg-gray-800 rounded p-3 text-sm">
                <div class="flex justify-between items-start mb-1">
                  <div class="font-bold text-purple-400">${i + 1}. ${rec.action}</div>
                  <div class="text-xs text-gray-400">${rec.timeEstimate}min | +${rec.impact}pts</div>
                </div>
                <div class="text-xs text-gray-400">${rec.issue}</div>
              </div>
            `).join('');
            
            console.log('‚úÖ Advanced HTML injected');
          }
        } else {
          console.log('‚ö†Ô∏è No Advanced to display');
        }
        
        console.log('‚úÖ ALL RECOMMENDATIONS PROCESSED');
        
      } else {
        console.log('‚ùå NO RECOMMENDATIONS IN DATA');
        recSection.classList.add('hidden');
      }
      
      console.log('üéØ Opening modal...');
      document.getElementById('resultsModal').classList.add('active');
      console.log('‚úÖ SHOWING RESULTS - COMPLETE');
    }

    function downloadPDFReport() {
      if (!currentScanResult) {
        console.error('No scan result to download');
        return;
      }
      
      const score = currentScanResult.score;
      const url = currentScanResult.url;
      const recs = currentScanResult.recommendations;
      
      let content = `CONTENTSCALE SEO REPORT\n${'='.repeat(60)}\n\nURL: ${url}\nScore: ${score}/100\nQuality: ${getQualityText(score)}\nDate: ${new Date().toLocaleString()}\n\nSCORE BREAKDOWN\n${'='.repeat(60)}\nGRAAF Framework: ${currentScanResult.breakdown.graaf.total}/50\nCRAFT Methodology: ${currentScanResult.breakdown.craft.total}/30\nTechnical SEO: ${currentScanResult.breakdown.technical.total}/20\n\n`;

      if (recs) {
        content += `RECOMMENDATIONS SUMMARY\n${'='.repeat(60)}\nTotal Issues: ${recs.summary.totalIssues}\nEstimated Fix Time: ${Math.round(recs.summary.estimatedTimeToFix / 60)} hours\nPotential Score Gain: +${recs.summary.potentialScoreGain} points\n\n`;

        if (recs.quickWins && recs.quickWins.length > 0) {
          content += `QUICK WINS (High Impact, Low Time)\n${'='.repeat(60)}\n`;
          recs.quickWins.forEach((rec, i) => {
            content += `${i + 1}. ${rec.action}\n   Issue: ${rec.issue}\n   Time: ${rec.timeEstimate}min | Impact: +${rec.impact}pts\n\n`;
          });
        }

        if (recs.majorImpact && recs.majorImpact.length > 0) {
          content += `MAJOR IMPACT (Critical for 90+)\n${'='.repeat(60)}\n`;
          recs.majorImpact.forEach((rec, i) => {
            content += `${i + 1}. ${rec.action}\n   Issue: ${rec.issue}\n   Time: ${rec.timeEstimate}min | Impact: +${rec.impact}pts\n\n`;
          });
        }

        if (recs.advanced && recs.advanced.length > 0) {
          content += `ADVANCED (For 95+)\n${'='.repeat(60)}\n`;
          recs.advanced.forEach((rec, i) => {
            content += `${i + 1}. ${rec.action}\n   Issue: ${rec.issue}\n   Time: ${rec.timeEstimate}min | Impact: +${rec.impact}pts\n\n`;
          });
        }
      }

      content += `\n${'='.repeat(60)}\nGenerated by ContentScale | contentscale.site\n`;

      const blob = new Blob([content], { type: 'text/plain' });
      const url2 = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url2;
      a.download = `ContentScale-Report-${score}-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url2);
      
      alert('‚úÖ Report downloaded!');
    }

    function getQualityText(score) {
      if (score >= 90) return 'Excellent! üåü';
      if (score >= 80) return 'Very Good! üëç';
      if (score >= 70) return 'Good ‚úì';
      if (score >= 60) return 'Fair ‚ö†Ô∏è';
      return 'Needs Improvement ‚ùå';
    }
    
    function getQualityEmoji(score) {
      if (score >= 90) return 'üåü';
      if (score >= 80) return 'üëç';
      if (score >= 70) return '‚úì';
      if (score >= 60) return '‚ö†Ô∏è';
      return '‚ùå';
    }

    function closeResultsModal() {
      document.getElementById('resultsModal').classList.remove('active');
    }

    function scanAnother() {
      closeResultsModal();
      document.getElementById('scan-url').value = '';
      document.getElementById('scan-url').focus();
    }

    document.getElementById('scan-url').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performScan();
    });

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Page loaded, validating link...');
      validateLink();
    });
  </script>

</body>
</html>
</body>
</html>
